<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AIOps RCA Console</title>
<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3039/3039387.png" />
<style>
  body{font-family:Segoe UI,Roboto,Arial;background:#0d1117;color:#e6eef6;margin:0}
  header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:#161b22;border-bottom:1px solid #30363d;box-shadow:0 2px 10px rgba(0,0,0,0.5)}
  h1{color:#58a6ff;margin:0;font-size:1.6em;text-shadow:0 0 8px #58a6ff80;animation:glow 3s infinite alternate}
  @keyframes glow {from{text-shadow:0 0 4px #58a6ff80;}to{text-shadow:0 0 15px #58a6ff;}}
  .btn{background:#238636;color:#fff;border:0;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:600;transition:0.2s}
  .btn:hover{background:#2ea043}
  .btn-secondary{background:#21262d;border:1px solid #30363d;color:#c9d1d9}
  .btn-secondary:hover{background:#30363d}
  .btn-download{background:#1f6feb;color:#fff;border:0;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:13px;margin-left:10px}
  .btn-download:hover{background:#388bfd}
  .btn-logout{background:#da3633;color:#fff;border:0;padding:8px 14px;border-radius:6px;cursor:pointer;font-weight:600;transition:0.2s}
  .btn-logout:hover{background:#f85149}
  
  .board{padding:18px}
  .row{display:flex;flex-wrap:wrap}
  .card{background:#0f1720;border:1px solid #222426;border-radius:8px;padding:14px;margin:10px;width:320px;box-shadow:0 4px 18px rgba(0,0,0,0.6);transition:transform 0.2s;overflow:hidden}
  .card:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,0.7)}
  .title{display:flex;justify-content:space-between;align-items:center}
  .badge{padding:4px 8px;border-radius:6px;font-weight:600}
  .sev-critical{background:#c92a2a;color:#fff}
  .sev-high{background:#f85149;color:#fff}
  .sev-medium{background:#d29922;color:#000}
  .sev-low{background:#2ea043;color:#fff}
  .priority{margin-left:8px;background:#222;color:#fff;padding:3px 6px;border-radius:4px;font-size:12px}
  .timer{font-size:13px;margin-top:8px}
  .muted{color:#9aa6b2;font-size:13px}
  .small{font-size:13px}
  .view-btn{background:#007bff;color:#fff;border:0;padding:6px 10px;border-radius:6px;cursor:pointer}
  .view-btn:hover{background:#0a84ff}
  #modal{position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:60}
  .modal-box{background:#0f1720;padding:18px;border-radius:8px;width:720px;max-width:95%;max-height:90vh;overflow-y:auto}
  pre {white-space:pre-wrap;word-break:break-word;color:#cbd5e1;background:#071018;padding:8px;border-radius:6px}
  .closed-tag{background:#16a34a;color:#072f0f;padding:6px 8px;border-radius:6px;font-weight:700}
  .rca-highlight{color:#93c5fd;font-weight:600;}
  .tabs{display:flex;gap:10px;margin-top:10px}
  .tab{padding:8px 12px;border-radius:8px;cursor:pointer;background:#071018;border:1px solid #26323a;color:#9fb6ff}
  .tab.active{background:#072b42;color:#fff;border-color:#113a63}
  .counts{display:inline-block;margin-left:12px;color:#9aa6b2;font-size:0.95em}
  .muted-top{color:#9aa6b2;margin-bottom:6px}
  .card .desc{max-height:72px;overflow:hidden;text-overflow:ellipsis}
  .search-container {margin-top:15px;margin-bottom:15px;}
  .search-container input {padding:10px;font-size:1em;background:#161b22;border:1px solid #30363d;color:#e6eef6;border-radius:6px;}
  
  /* --- Audit Table & Colors --- */
  .audit-container{padding:18px}
  table.audit-table {width:100%;border-collapse:collapse;margin-top:15px;font-size:13px}
  table.audit-table th, table.audit-table td {padding:10px 8px;border-bottom:1px solid #26323a;text-align:left}
  table.audit-table th {background:#161b22;color:#79c0ff;position:sticky;top:0;z-index:10}
  table.audit-table tr:hover {background:#1a1f27}
  table.audit-table td{color:#e6eef6}
  
  .action-badge{padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600;display:inline-block; background-color: #30363d; color: #c9d1d9;}
  /* Green */
  .action-ticket-closed {background-color:#2ea043;color:#fff;}
  .action-auto-remediation-success {background-color:#2ea043;color:#fff;}
  .action-jira\:-done {background-color:#2ea043;color:#fff;}
  
  /* Blue */
  .action-ticket-created {background-color:#1f6feb;color:#fff;}
  .action-jira-ticket-created {background-color:#1f6feb;color:#fff;}
  .action-logic-app-forwarded {background-color:#1f6feb;color:#fff;}
  .action-jira\:-backlog {background-color:#1f6feb;color:#fff;}
  
  /* Yellow / Orange */
  .action-jira\:-in-progress {background-color:#d29922;color:#000;}
  .action-jira\:-selected-for-development {background-color:#d29922;color:#000;}
  .action-jira\:-in-review {background-color:#d29922;color:#000;}

  /* Purple / Magenta */
  .action-slack-notification-sent {background-color:#4a154b;color:#fff;}
  .action-auto-remediation-triggered {background-color:#9e3a8a;color:#fff;}

  /* Red */
  .action-auto-remediation-failed {background-color:#da3633;color:#fff;}
  .action-jira-ticket-failed {background-color:#da3633;color:#fff;}
  .action-slack-notification-failed {background-color:#da3633;color:#fff;}
  
  .sla-met{color:#2ea043;font-weight:600}
  .sla-breached{color:#f85149;font-weight:600}
  
  .filter-controls{margin:15px 0;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .filter-controls select{padding:8px 12px;background:#161b22;border:1px solid #30363d;color:#e6eef6;border-radius:6px;cursor:pointer}
  
  .stat-cards{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap}
  .stat-card{background:#0f1720;border:1px solid #222426;border-radius:8px;padding:15px;min-width:180px;flex:1}
  .stat-card h3{margin:0 0 8px 0;font-size:14px;color:#9aa6b2}
  .stat-card .stat-value{font-size:28px;font-weight:700;color:#58a6ff}
  
  .finops-tag{background:#1f2937;color:#fbbf24;padding:3px 8px;border-radius:4px;font-size:11px;margin-right:5px;display:inline-block}
  .itsm-tag{background:#0052cc;color:#fff;padding:3px 8px;border-radius:4px;font-size:11px;margin-right:5px;display:inline-block;text-decoration:none;font-weight:600}
  .itsm-tag:hover{background:#0065ff}
  
  .user-info{color:#9aa6b2;font-size:14px;margin-right:15px}
  .header-right{display:flex;align-items:center}
</style>
</head>
<body>
<header>
  <h1>AIOps RCA Console</h1>
  <div class="header-right">
    <span class="user-info" id="user-email">Loading...</span>
    <button class="btn-logout" onclick="logout()">Logout</button>
  </div>
</header>

<!-- MAIN TABS -->
<div class="tabs main-tabs" style="margin-left:20px">
  <div id="tab-dashboard" class="tab active" onclick="switchMainTab('dashboard')">Dashboard</div>
  <div id="tab-audit" class="tab" onclick="switchMainTab('audit')">Audit Trail</div>
</div>

<!-- DASHBOARD SECTION -->
<div class="board" id="dashboard-section">
  <div class="muted-top" id="last-updated"></div>
  
  <!-- 3-TAB NAVIGATION -->
  <div class="tabs" style="align-items:center">
    <div id="tab-open" class="tab active" onclick="switchTab('open')">Open <span class="counts" id="count-open"></span></div>
    <div id="tab-in-progress" class="tab" onclick="switchTab('in_progress')">In Progress <span class="counts" id="count-in-progress"></span></div>
    <div id="tab-closed" class="tab" onclick="switchTab('closed')">Closed <span class="counts" id="count-closed"></span></div>
    <button class="btn-download" onclick="downloadCurrentTab()">Download CSV</button>
  </div>

  <div class="search-container">
      <input type="text" id="ticket-search" placeholder="Search by Ticket ID, Pipeline, RCA, or ITSM ID..." onkeyup="filterTickets()" />
  </div>
  
  <h2 style="color:#79c0ff;margin-top:12px" id="section-title">Open Tickets</h2>
  <div id="tickets" class="row"></div>
</div>

<!-- AUDIT TRAIL SECTION -->
<div id="audit-section" style="display:none">
  <div class="audit-container">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="color:#79c0ff;margin-bottom:10px">Audit Trail</h2>
      <button class="btn-download" onclick="downloadAuditTrail()">Download CSV</button>
    </div>
    
    <div class="stat-cards" id="audit-stats"></div>
    
    <div class="filter-controls">
      <label style="color:#9aa6b2">Filter by Action:</label>
      <select id="action-filter" onchange="loadAuditTrail()">
        <option value="all">All Actions</option>
        <option value="Ticket Created">Ticket Created</option>
        <option value="Ticket Closed">Ticket Closed</option>
        <option value="Jira:">Jira:</option>
        <option value="Logic App Forwarded">Logic App Forwarded</option>
        <option value="Auto-Remediation">Auto-Remediation</option>
      </select>
      
      <input type="text" id="audit-search" placeholder="Search audit logs..." onkeyup="filterAuditTable()" 
             style="flex:1;max-width:400px;padding:8px;background:#161b22;border:1px solid #30363d;color:#e6eef6;border-radius:6px" />
    </div>
    
    <div id="audit-table-container" class="muted">Loading audit logs...</div>
  </div>
</div>

<!-- MODAL (READ-ONLY) -->
<div id="modal">
  <div class="modal-box">
    <h3 id="m-title"></h3>
    <p class="muted small">
      Error Type: <span id="m-error-type">N/A</span> 
      Affected Entity: <span id="m-affected-entity">N/A</span>
    </p>
    <div id="m-finops" style="margin:8px 0"></div>
    <div id="m-itsm-link" style="margin:8px 0"></div>
    <p id="m-rca" class="small rca-highlight"></p>
    <pre id="m-recs" class="small"></pre>
    <p id="m-meta" class="muted"></p>
    
    <!-- CLOSED/IN-PROGRESS AREA -->
    <div id="closed-area" style="display:none;margin-top:10px">
      <div id="status-tag" class="closed-tag"></div>
    </div>

    <!-- READ-ONLY: No input fields or action buttons -->
    <div style="margin-top:15px; border-top: 1px solid #30363d; padding-top: 15px;">
      <button class="btn-secondary" onclick="closeModal()">Close</button>
    </div>
    
  </div>
</div>

<script>
let allTickets = [], openTickets = [], inProgressTickets = [], closedTickets = [], selected = null;
let currentTab = 'open';
let auditData = [];
let appConfig = { itsm_tool: "none", jira_domain: "" };
let timers = {};
let authToken = localStorage.getItem('authToken');

// --- Helper Functions ---
function sevClass(s){s=(s||"Medium").toLowerCase();if(s==="critical")return"sev-critical";if(s==="high")return"sev-high";if(s==="medium")return"sev-medium";return"sev-low";}
function priorityNumber(p){if(!p)return 4;const n=parseInt((p+"").replace("P",""))||4;return n;}
function safeJsonParse(s){try{return JSON.parse(s);}catch(e){return null;}}
function escapeHtml(s){if(!s)return'';return s.replace(/[&<>"'`=\/]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c]));}
function buildJiraLink(key) {
  if (appConfig.itsm_tool === 'jira' && appConfig.jira_domain && key) {
    return `<a href="${escapeHtml(appConfig.jira_domain)}/browse/${escapeHtml(key)}" target="_blank" class="itsm-tag">Jira: ${escapeHtml(key)}</a>`;
  } else if (key) {
    return `<span class="itsm-tag">ITSM: ${escapeHtml(key)}</span>`;
  }
  return '';
}

// --- Authentication Functions ---
function checkAuth() {
  if (!authToken) {
    window.location.href = '/login';
    return false;
  }
  return true;
}

async function fetchWithAuth(url, options = {}) {
  if (!authToken) {
    window.location.href = '/login';
    return;
  }
  
  options.headers = options.headers || {};
  options.headers['Authorization'] = `Bearer ${authToken}`;
  
  try {
    const response = await fetch(url, options);
    if (response.status === 401) {
      localStorage.removeItem('authToken');
      window.location.href = '/login';
      return null;
    }
    return response;
  } catch (error) {
    console.error('Fetch error:', error);
    return null;
  }
}

async function loadUserInfo() {
  try {
    const res = await fetchWithAuth('/api/me');
    if (res && res.ok) {
      const data = await res.json();
      document.getElementById('user-email').innerText = data.email;
    }
  } catch (e) {
    console.error('Failed to load user info:', e);
  }
}

function logout() {
  localStorage.removeItem('authToken');
  window.location.href = '/login';
}

// --- Data Fetching ---
async function fetchConfig() {
  try {
    const res = await fetch('/api/config');
    const data = await res.json();
    appConfig = data;
  } catch (e) {
    console.error("Failed to fetch config", e);
  }
}

async function fetchOpen(){
  try{
    const res=await fetchWithAuth('/api/open-tickets');
    if (!res) return;
    const data=await res.json();
    openTickets=data.tickets||[];
    document.getElementById('count-open').innerText=`(${openTickets.length})`;
  }catch(e){
    openTickets=[];
    document.getElementById('count-open').innerText=`(0)`;
  }
}

async function fetchInProgress(){
  try{
    const res=await fetchWithAuth('/api/in-progress-tickets');
    if (!res) return;
    const data=await res.json();
    inProgressTickets=data.tickets||[];
    document.getElementById('count-in-progress').innerText=`(${inProgressTickets.length})`;
  }catch(e){
    inProgressTickets=[];
    document.getElementById('count-in-progress').innerText=`(0)`;
  }
}

async function fetchClosed(){
  try{
    const res=await fetchWithAuth('/api/closed-tickets');
    if (!res) return;
    const data=await res.json();
    closedTickets=data.tickets||[];
    document.getElementById('count-closed').innerText=`(${closedTickets.length})`;
  }catch(e){
    closedTickets=[];
    document.getElementById('count-closed').innerText=`(0)`;
  }
}

async function refreshAll(){
  await Promise.all([fetchOpen(), fetchInProgress(), fetchClosed()]);
  // Combine all tickets for filtering/modal view
  allTickets = [...openTickets, ...inProgressTickets, ...closedTickets];
  render();
  document.getElementById('last-updated').innerText = `Last updated: ${new Date().toLocaleString()}`;
}

// --- Tab & Rendering Logic ---
function switchTab(tab){
  currentTab = tab;
  document.getElementById('ticket-search').value = '';
  document.getElementById('tab-open').classList.toggle('active', tab==='open');
  document.getElementById('tab-in-progress').classList.toggle('active', tab==='in_progress');
  document.getElementById('tab-closed').classList.toggle('active', tab==='closed');

  if (tab === 'open') document.getElementById('section-title').innerText = 'Open Tickets';
  else if (tab === 'in_progress') document.getElementById('section-title').innerText = 'In Progress Tickets';
  else if (tab === 'closed') document.getElementById('section-title').innerText = 'Closed Tickets';

  render();
}

function filterTickets(){render();}

function render(){
  const el=document.getElementById('tickets');
  el.innerHTML='';
  const searchInput=document.getElementById('ticket-search').value.toLowerCase();
  
  let list = [];
  if (currentTab === 'open') list = openTickets;
  else if (currentTab === 'in_progress') list = inProgressTickets;
  else if (currentTab === 'closed') list = closedTickets;

  // Sort logic
  list.sort((a,b)=>{
    const tsA=new Date(a.timestamp).getTime();
    const tsB=new Date(b.timestamp).getTime();
    if(tsA!==tsB)return tsB-tsA;
    if(currentTab==='open'||currentTab==='in_progress'){const pa=priorityNumber(a.priority),pb=priorityNumber(b.priority);if(pa!==pb)return pa-pb;const order={"Critical":1,"High":2,"Medium":3,"Low":4};return(order[a.severity]||3)-(order[b.severity]||3);}
    return 0;
  });
  
  const filteredList=list.filter(t=>{
    if(!searchInput)return true;
    const rca=(t.rca_result||t.root_cause||'').toLowerCase();
    const pipeline=(t.pipeline||'').toLowerCase();
    const id=(t.id||'').toLowerCase();
    const itsm_id=(t.itsm_ticket_id||'').toLowerCase();
    const emp=(t.ack_user||'').toLowerCase();
    const empid=(t.ack_empid||'').toLowerCase();
    return id.includes(searchInput)||pipeline.includes(searchInput)||rca.includes(searchInput)||emp.includes(searchInput)||empid.includes(searchInput)||itsm_id.includes(searchInput);
  });
  
  // Clear old timers
  Object.values(timers).forEach(clearInterval);
  timers = {};
  
  filteredList.forEach(t=>{
    const badge=`<span class="badge ${sevClass(t.severity)}">${t.severity||'Medium'}</span><span class="priority">${t.priority||'P4'}</span>`;
    const rca=(t.rca_result||t.root_cause||'');const snippet=rca.length>140?rca.slice(0,140)+"...":rca;
    
    let statusBtn=`<button onclick="openModal('${t.id}')" class="view-btn">View Details</button>`;
    
    let finopsTags = '';
    if(t.finops_team || t.finops_owner){
      finopsTags = `<div class="muted small" style="margin-top:5px">`;
      if(t.finops_team) finopsTags += `<span class="finops-tag">${escapeHtml(t.finops_team)}</span>`;
      if(t.finops_owner) finopsTags += `<span class="finops-tag">${escapeHtml(t.finops_owner)}</span>`;
      finopsTags += `</div>`;
    }
    
    const itsmLink = buildJiraLink(t.itsm_ticket_id);
    
    el.innerHTML+=`
      <div class="card">
        <div class="title">
          <div><strong>${escapeHtml(t.pipeline||'ADF')}</strong><div class="muted small">${escapeHtml(t.id)}</div></div>
          <div>${badge}</div>
        </div>
        <p class="small desc">${escapeHtml(snippet)}</p>
        <div class="muted small">Run: ${escapeHtml(t.run_id||'N/A')}  ${new Date(t.timestamp).toLocaleString()}</div>
        <div style="margin-top:5px">${itsmLink}</div>
        ${finopsTags}
        <div id="timer-${t.id}" class="timer"></div>
        <div style="margin-top:8px">${statusBtn}</div>
      </div>`;
    startTimer(t);
  });
  if(filteredList.length===0){el.innerHTML=`<div style="padding:20px;color:#9aa6b2;">No tickets found matching your criteria.</div>`;}
}

function startTimer(t){
  const id=`timer-${t.id}`;setTimeout(()=>{const el=document.getElementById(id);if(!el)return;
    const created=new Date(t.timestamp);const sla=(+t.sla_seconds)||1800;
    function tick(){
      if(t.status==='acknowledged'){el.innerHTML=`<span style="color:#2ea043">SLA ${t.sla_status||'Met'}</span>`;return;}
      const now=new Date();const diff=Math.floor((now-created)/1000);const rem=sla-diff;
      if(rem>0){const m=Math.floor(rem/60),s=rem%60;el.innerHTML=`<span style="color:${rem<120?'#d29922':'#2ea043'}">SLA ${m}m ${s}s left</span>`;}else{el.innerHTML=`<span style="color:#f85149">SLA Breached</span>`;}
    }
    tick();
    if(t.status==='open'){ const newInterval=setInterval(tick,1000); timers[t.id] = newInterval; }
  },50);
}

// --- Modal & Action Logic ---
async function openModal(id){
  // Find from all tickets
  let basicTicket=allTickets.find(x=>x.id===id);
  if(!basicTicket)return;
  let fullTicket;
  try{
    const res=await fetchWithAuth(`/api/tickets/${id}`);
    if (!res) return;
    const data=await res.json();
    fullTicket=data.ticket;
  }
  catch(e){fullTicket=basicTicket;}
  selected=fullTicket;
  document.getElementById('m-title').innerText=`${selected.id}  ${selected.pipeline}`;
  document.getElementById('m-rca').innerText=selected.rca_result||(selected.root_cause||'');
  document.getElementById('m-error-type').innerText=selected.error_type||'N/A';
  document.getElementById('m-affected-entity').innerText=selected.affected_entity||'N/A';
  
  let finopsHtml = '';
  if(selected.finops_team || selected.finops_owner || selected.finops_cost_center){
    finopsHtml = '<div style="margin:10px 0;padding:10px;background:#1a1f27;border-radius:6px"><strong style="color:#79c0ff">FinOps Tags:</strong><br/>';
    if(selected.finops_team) finopsHtml += `<span class="finops-tag">Team: ${escapeHtml(selected.finops_team)}</span>`;
    if(selected.finops_owner) finopsHtml += `<span class="finops-tag">Owner: ${escapeHtml(selected.finops_owner)}</span>`;
    if(selected.finops_cost_center) finopsHtml += `<span class="finops-tag">Cost Center: ${escapeHtml(selected.finops_cost_center)}</span>`;
    finopsHtml += '</div>';
  }
  document.getElementById('m-finops').innerHTML = finopsHtml;
  document.getElementById('m-itsm-link').innerHTML = buildJiraLink(selected.itsm_ticket_id);
  
  const recs=Array.isArray(selected.recommendations)?selected.recommendations:(typeof selected.recommendations==="string"?safeJsonParse(selected.recommendations)||[selected.recommendations]:[]);
  document.getElementById('m-recs').innerText=(recs&&recs.length)?" "+(recs||[]).join("\n"):"No recommendations.";
  
  const closedArea = document.getElementById('closed-area');
  const statusTag = document.getElementById('status-tag');
  
  if(selected.status==='acknowledged'){
    closedArea.style.display='block';
    const ackTime = selected.ack_ts ? new Date(selected.ack_ts).toLocaleString() : '';
    const mttr = selected.ack_seconds ? `MTTR: ${Math.round(selected.ack_seconds/60)} min` : '';
    statusTag.className = "closed-tag";
    statusTag.innerText=`Closed by: ${selected.ack_user||'unknown'} (${selected.ack_empid||'N/A'})  ${ackTime}  ${mttr}`;
    document.getElementById('m-meta').innerText=`Priority: ${selected.priority||'P4'}  Severity: ${selected.severity||'Medium'}  Status: Closed`;
  } else {
    closedArea.style.display='none';
    document.getElementById('m-meta').innerText=`Priority: ${selected.priority||'P4'}  Severity: ${selected.severity||'Medium'} Status: Open`;
  }
  
  document.getElementById('modal').style.display='flex';
}

function closeModal(){document.getElementById('modal').style.display='none';selected=null;}

/* MAIN TAB SWITCHING */
function switchMainTab(tab){
  const dashTab=document.getElementById('tab-dashboard');
  const auditTab=document.getElementById('tab-audit');
  const dashboardSection=document.getElementById('dashboard-section');
  const auditSection=document.getElementById('audit-section');
  if(tab==='dashboard'){
    dashTab.classList.add('active');auditTab.classList.remove('active');
    dashboardSection.style.display='block';auditSection.style.display='none';
  }else{
    dashTab.classList.remove('active');auditTab.classList.add('active');
    dashboardSection.style.display='none';auditSection.style.display='block';
    loadAuditTrail();
  }
}

// ---Audit Trail Logic ---
function getActionBadgeClass(action){
  const actionLower = (action||'').toLowerCase();
  
  if (actionLower.startsWith('jira:')) {
    const status = actionLower.replace('jira:', '').trim().replace(/[^a-z0-9-]/g, '-');
    return `action-jira-${status}`;
  }
  
  const standardClass = (action||'').toLowerCase().replace(/[^a-z0-9-]/g, '-');
  return `action-${standardClass}`;
}

async function loadAuditTrail(){
  try{
    const actionFilter = document.getElementById('action-filter').value;
    const url = actionFilter === 'all' ? '/api/audit-trail' : `/api/audit-trail?action=${encodeURIComponent(actionFilter)}`;
    
    const res = await fetchWithAuth(url);
    if (!res) return;
    const data = await res.json();
    auditData = data.audits || [];
    
    const summaryRes = await fetchWithAuth('/api/summary');
    if (!summaryRes) return;
    const summaryData = await summaryRes.json();
    
    renderAuditStats(summaryData);
    renderAuditTable(auditData);
  }catch(e){
    document.getElementById('audit-table-container').innerHTML='<div style="color:red">Failed to load audit logs.</div>';
  }
}

function renderAuditStats(summary){
  const statsEl = document.getElementById('audit-stats');
  
  let html = `<div class="stat-card">
    <h3>Open</h3>
    <div class="stat-value">${summary.open_tickets || 0}</div>
  </div>
  <div class="stat-card">
    <h3>Closed</h3>
    <div class="stat-value">${summary.acknowledged_tickets || 0}</div>
  </div>
  <div class="stat-card">
    <h3>MTTR (min)</h3>
    <div class="stat-value">${summary.mttr_min || 0}</div>
  </div>
  <div class="stat-card">
    <h3>SLA Breached</h3>
    <div class="stat-value">${summary.sla_breached || 0}</div>
  </div>
  <div class="stat-card">
    <h3>Total Audits</h3>
    <div class="stat-value">${summary.total_audits || 0}</div>
  </div>`;
  
  statsEl.innerHTML = html;
}

function renderAuditTable(audits){
  const container = document.getElementById('audit-table-container');
  if(!audits.length){
    container.innerHTML='<div style="color:#9aa6b2;padding:20px">No audit records found.</div>';
    return;
  }
  
  let html = '<table class="audit-table"><thead><tr>';
  html += '<th>Timestamp</th>';
  html += '<th>Ticket ID</th>';
  html += '<th>Pipeline</th>';
  html += '<th>Action</th>';
  html += '<th>ITSM ID</th>'; // NEW COLUMN
  html += '<th>User</th>';
  html += '<th>Time Taken</th>';
  html += '<th>MTTR</th>';
  html += '<th>SLA Status</th>';
  html += '<th>FinOps Team</th>';
  html += '<th>Details</th>';
  html += '</tr></thead><tbody>';
  
  audits.forEach(a => {
    const timestamp = a.timestamp ? new Date(a.timestamp).toLocaleString() : 'N/A';
    const ticketId = escapeHtml(a.ticket_id || 'N/A');
    const pipeline = escapeHtml(a.pipeline || 'N/A');
    const action = a.action || 'N/A';
    const actionBadge = `<span class="action-badge ${getActionBadgeClass(action)}">${escapeHtml(action)}</span>`;
    const itsmId = a.itsm_ticket_id ? buildJiraLink(a.itsm_ticket_id) : '-'; // NEW
    const user = a.user_name ? `${escapeHtml(a.user_name)} (${escapeHtml(a.user_empid||'')})` : '-';
    const timeTaken = a.time_taken_seconds ? `${Math.round(a.time_taken_seconds/60)} min` : '-';
    const mttr = a.mttr_minutes ? `${a.mttr_minutes.toFixed(1)} min` : '-';
    const slaStatus = a.sla_status ? `<span class="${a.sla_status==='Met'?'sla-met':'sla-breached'}">${escapeHtml(a.sla_status)}</span>` : '-';
    const finopsTeam = escapeHtml(a.finops_team || '-');
    const details = escapeHtml((a.details || '').substring(0, 100)) + ((a.details||'').length > 100 ? '...' : '');
    
    html += `<tr>
      <td>${timestamp}</td>
      <td style="font-family:monospace;font-size:11px">${ticketId}</td>
      <td>${pipeline}</td>
      <td>${actionBadge}</td>
      <td>${itsmId}</td>
      <td>${user}</td>
      <td>${timeTaken}</td>
      <td>${mttr}</td>
      <td>${slaStatus}</td>
      <td>${finopsTeam}</td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escapeHtml(a.details||'')}">${details}</td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
}

function filterAuditTable(){
  const searchTerm = document.getElementById('audit-search').value.toLowerCase();
  if(!searchTerm){
    renderAuditTable(auditData);
    return;
  }
  
  const filtered = auditData.filter(a => {
    return (a.ticket_id||'').toLowerCase().includes(searchTerm) ||
           (a.pipeline||'').toLowerCase().includes(searchTerm) ||
           (a.action||'').toLowerCase().includes(searchTerm) ||
           (a.user_name||'').toLowerCase().includes(searchTerm) ||
           (a.finops_team||'').toLowerCase().includes(searchTerm) ||
           (a.itsm_ticket_id||'').toLowerCase().includes(searchTerm) ||
           (a.details||'').toLowerCase().includes(searchTerm);
  });
  
  renderAuditTable(filtered);
}

// --- Download Functions ---
async function downloadCurrentTab() {
  let endpoint;
  if (currentTab === 'open') endpoint = '/api/export/open-tickets';
  else if (currentTab === 'in_progress') endpoint = '/api/export/in-progress-tickets';
  else endpoint = '/api/export/closed-tickets';

  try {
    const res = await fetchWithAuth(endpoint);
    if (!res) return;
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentTab}_tickets_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  } catch (e) {
    console.error('Download failed:', e);
    alert('Failed to download report');
  }
}

async function downloadAuditTrail() {
  try {
    const res = await fetchWithAuth('/api/export/audit-trail');
    if (!res) return;
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `audit_trail_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  } catch (e) {
    console.error('Download failed:', e);
    alert('Failed to download audit trail');
  }
}

/* INIT & WebSocket */
async function init() {
  if (!checkAuth()) return;
  
  await loadUserInfo();
  await fetchConfig();
  await refreshAll();
  
  try{
    const ws=new WebSocket((location.protocol==='https:'?'wss://':'ws://')+location.host+'/ws');
    ws.onmessage=function(evt){
      try{
        const d=JSON.parse(evt.data);
        if(d && (d.event === 'new_ticket' || d.event === 'status_update' || d.event === 'acknowledged')){
          console.log('WebSocket received event, refreshing all data:', d);
          refreshAll();
        }
      }catch(e){
        console.error("WebSocket error", e);
      }
    }
    ws.onopen = () => console.log("WebSocket connected.");
    ws.onclose = () => console.log("WebSocket disconnected. Retrying...");
  }catch(e){
    console.error("WebSocket connection failed", e);
  }
  
  // Fallback poller
  setInterval(refreshAll, 15000);
}

init();
</script>
</body>
</html>