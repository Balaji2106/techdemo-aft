# ============================================
# ENHANCED AUTO-RECOVERY SYSTEM - Environment Variables
# ============================================
# Copy this file to .env and fill in your values
#
# NEW FEATURES:
# ✅ Direct API calls (no Logic Apps needed for Databricks)
# ✅ Circuit breakers
# ✅ Health checks
# ✅ Fallback strategies
# ✅ Cluster failure detection

# ============================================
# DATABRICKS API CREDENTIALS (REQUIRED)
# ============================================
# Used for:
# - Fetching detailed job/cluster errors
# - Executing auto-recovery (retry, restart, scale)
# - Health checks after recovery
# - Cluster failure detection

DATABRICKS_HOST=https://adb-1234567890123456.7.azuredatabricks.net
DATABRICKS_TOKEN=dapi1234567890abcdef...

# ============================================
# AUTO-REMEDIATION CONFIGURATION
# ============================================

# Enable/disable auto-remediation globally
AUTO_REMEDIATION_ENABLED=true

# Maximum retry attempts for job retries
AUTO_REMEDIATION_MAX_RETRIES=3

# Retry delay configuration (exponential backoff)
RETRY_BASE_DELAY_SECONDS=30
RETRY_MAX_DELAY_SECONDS=300

# Auto-scaling configuration
AUTO_SCALE_ENABLED=true
MAX_CLUSTER_WORKERS=10
SCALE_UP_PERCENTAGE=50

# Auto-restart configuration
AUTO_RESTART_ENABLED=true
RESTART_TIMEOUT_MINUTES=10

# ============================================
# ADF AUTO-REMEDIATION CONFIGURATION (NEW)
# ============================================

# Logic App webhook URL for ADF pipeline retry
ADF_RETRY_LOGIC_APP_WEBHOOK=https://prod-23.northcentralus.logic.azure.com:443/workflows/YOUR-WORKFLOW-ID/triggers/When_RCA_sends_auto_remediation_request/paths/invoke

# Maximum retry attempts for ADF pipelines
ADF_MAX_RETRIES=2

# Delay between retry attempts (seconds)
ADF_RETRY_DELAY_SECONDS=60

# ============================================
# CIRCUIT BREAKER CONFIGURATION (NEW)
# ============================================

# Number of consecutive failures before circuit opens
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5

# Time to wait (seconds) before attempting recovery again after circuit opens
CIRCUIT_BREAKER_TIMEOUT_SECONDS=300

# Enable/disable circuit breakers globally
CIRCUIT_BREAKER_ENABLED=true

# ============================================
# HEALTH CHECK CONFIGURATION (NEW)
# ============================================

# Enable health checks after recovery
HEALTH_CHECK_ENABLED=true

# Timeout for health check operations (seconds)
HEALTH_CHECK_TIMEOUT_SECONDS=60

# Wait for job completion after retry (seconds)
JOB_COMPLETION_TIMEOUT_SECONDS=600

# ============================================
# PLAYBOOK CONFIGURATION (NEW - OPTIONAL)
# ============================================
# Override default playbook settings
# (Most settings are in playbook_config.py, these are overrides)

# Default timeout for all playbook actions
DEFAULT_PLAYBOOK_TIMEOUT_SECONDS=300

# Enable rollback on recovery failure
ENABLE_ROLLBACK=true

# Capture snapshots before recovery actions
SNAPSHOT_BEFORE_ACTION=true

# ============================================
# AI/RCA CONFIGURATION (EXISTING)
# ============================================

# PRIMARY AI PROVIDER: Google Gemini
GEMINI_API_KEY=your-gemini-api-key
GEMINI_MODEL_ID=models/gemini-2.0-flash-exp

# FALLBACK AI PROVIDER: Ollama (self-hosted/local)
# If Gemini fails, system automatically falls back to Ollama
OLLAMA_HOST=http://172.190.86.69:11434
OLLAMA_MODEL=deepseek-r1:latest
OLLAMA_TIMEOUT=120

# Note: Configure at least one AI provider (Gemini OR Ollama)
# System will use providers in order: Gemini → Ollama → Fallback RCA

# RCA System API Key (for webhook authentication)
RCA_API_KEY=balaji-rca-secret-2025

# Public URL for webhooks and notifications
PUBLIC_BASE_URL=https://your-domain.com

# ============================================
# DATABASE CONFIGURATION (EXISTING)
# ============================================

# Database type: "sqlite" or "azuresql"
DB_TYPE=sqlite
DB_PATH=data/tickets.db

# Azure SQL (if DB_TYPE=azuresql)
AZURE_SQL_SERVER=your-server.database.windows.net
AZURE_SQL_DATABASE=rca_database
AZURE_SQL_USERNAME=your-username
AZURE_SQL_PASSWORD=your-password

# ============================================
# AUTHENTICATION (EXISTING)
# ============================================

JWT_SECRET_KEY=your-long-random-secret-key-change-this-in-production
JWT_ALGORITHM=HS256
JWT_EXPIRATION_HOURS=24

# ============================================
# SLACK NOTIFICATIONS (EXISTING)
# ============================================

SLACK_BOT_TOKEN=xoxb-your-slack-bot-token
SLACK_ALERT_CHANNEL=aiops-rca-alerts

# ============================================
# JIRA INTEGRATION (EXISTING)
# ============================================

ITSM_TOOL=jira
JIRA_DOMAIN=https://your-company.atlassian.net
JIRA_USER_EMAIL=your-email@company.com
JIRA_API_TOKEN=your-jira-api-token
JIRA_PROJECT_KEY=RCA
JIRA_WEBHOOK_SECRET=your-jira-webhook-secret

# ============================================
# AZURE BLOB STORAGE (EXISTING - OPTIONAL)
# ============================================

AZURE_BLOB_ENABLED=false
AZURE_STORAGE_CONN=DefaultEndpointsProtocol=https;AccountName=...
AZURE_BLOB_CONTAINER_NAME=audit-logs

# ============================================
# LOGIC APP PLAYBOOKS (LEGACY - OPTIONAL)
# ============================================
# NOTE: With the enhanced system, you don't need Logic Apps for Databricks!
# These are only needed if you want to use Logic Apps for:
# - ADF pipeline orchestration
# - Complex multi-step workflows
# - Integration with other Azure services

# ADF Recovery Playbooks
PLAYBOOK_RERUN_UPSTREAM=https://your-logic-app-url-1
PLAYBOOK_RETRY_PIPELINE=https://your-logic-app-url-2

# Databricks Recovery Playbooks (OPTIONAL - Direct API is better!)
# PLAYBOOK_RESTART_CLUSTER=https://your-logic-app-url-3
# PLAYBOOK_RETRY_JOB=https://your-logic-app-url-4
# PLAYBOOK_REINSTALL_LIBRARIES=https://your-logic-app-url-5
# PLAYBOOK_SCALE_OUT_CLUSTER=https://your-logic-app-url-6
# PLAYBOOK_ROLLBACK_CONFIG=https://your-logic-app-url-7

# ============================================
# MONITORING & LOGGING (OPTIONAL)
# ============================================

# Log level: DEBUG, INFO, WARNING, ERROR
LOG_LEVEL=INFO

# Enable verbose logging for debugging
VERBOSE_LOGGING=false

# ============================================
# ADVANCED CONFIGURATION (OPTIONAL)
# ============================================

# Parallel webhook processing
MAX_CONCURRENT_WEBHOOKS=10

# Retry configuration for external API calls
API_RETRY_ATTEMPTS=3
API_RETRY_BACKOFF=2

# WebSocket configuration
WEBSOCKET_HEARTBEAT_INTERVAL=30

# ============================================
# CLUSTER FAILURE MONITORING (NEW - OPTIONAL)
# ============================================

# Enable background cluster monitoring (polling)
ENABLE_CLUSTER_POLLING=false

# Polling interval for cluster health checks (seconds)
CLUSTER_POLL_INTERVAL_SECONDS=300

# ============================================
# FEATURE FLAGS (NEW)
# ============================================

# Enable/disable specific recovery actions
ENABLE_JOB_RETRY=true
ENABLE_CLUSTER_RESTART=true
ENABLE_CLUSTER_SCALING=true
ENABLE_LIBRARY_FALLBACK=true
ENABLE_CONFIG_ROLLBACK=false  # Not fully implemented yet

# ============================================
# NOTIFICATION THRESHOLDS (OPTIONAL)
# ============================================

# Send alert when circuit breaker opens
ALERT_ON_CIRCUIT_OPEN=true

# Send alert when recovery fails N times
ALERT_ON_RECOVERY_FAILURE_COUNT=3

# Send alert when SLA is breached
ALERT_ON_SLA_BREACH=true
